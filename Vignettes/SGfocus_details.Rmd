---
title: "ForestSearch Parameter Guide: sg_focus Options"
author: "ForestSearch Documentation"
date: "`r Sys.Date()`"
output: 
  html_document:
  toc: true
toc_float: true
toc_depth: 3
number_sections: true
code_folding: show
theme: cosmo
---
  
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 10,
  fig.height = 6
)

# Load required libraries
library(forestsearch)
library(knitr)
library(DT)
library(DiagrammeR)
```

# Overview of sg_focus Parameter

The `sg_focus` parameter determines **which subgroup to prioritize** when multiple candidates meet the consistency criteria. It represents different clinical and statistical objectives for identifying treatment harm subgroups.

## Quick Reference Table
```{r sg-focus-table, echo=FALSE}
sg_focus_summary <- data.frame(
  Option = c("hr", "maxSG", "minSG", "hrMaxSG", "hrMinSG"),
  `Statistical Goal` = c(
    "Most reliable harmful effect",
    "Largest subgroup with harm",
    "Most specific subgroup with harm",
    "Largest subgroup with meaningful harm",
    "Most specific subgroup with meaningful harm"
  ),
  `Clinical Question` = c(
    "What harm are we most sure about?",
    "How many patients could we protect?",
    "Who is at highest risk?",
    "What's the biggest problem we're confident about?",
    "What's the most specific serious risk?"
  ),
  `Typical Use Case` = c(
    "Regulatory submissions",
    "Population health decisions",
    "Precision medicine",
    "Benefit-risk balance",
    "Biomarker development"
  ),
  stringsAsFactors = FALSE
)

kable(sg_focus_summary, 
      col.names = c("Option", "Statistical Goal", "Clinical Question", "Typical Use Case"),
      caption = "Summary of sg_focus Options")
```

# Detailed Description of Each Option

## sg_focus = "hr" (Default) {.tabset}

### Statistical Goal
Identify the subgroup with the **most reliable harmful effect**
  
  ### Selection Priority
  1. Highest consistency rate (Pcons)
2. Largest hazard ratio (HR)
3. Smallest number of factors (K)

### When to Use
- You want the most **statistically robust** finding
- Regulatory submissions requiring high confidence
- Primary goal is identifying clear treatment harm

### Example Code
```{r hr-example, eval=FALSE}
# Goal: FDA submission for drug approval
# Need: Most reliable evidence of harm
result <- forestsearch(
  df.analysis = cvd_trial,
  sg_focus = "hr",              # Statistical reliability
  hr.threshold = 1.3,           # Clinically meaningful
  pconsistency.threshold = 0.95 # Very high confidence
)

# Example interpretation of results:
# Two candidate subgroups found:
# Subgroup A: HR=1.8, Pcons=0.95, n=80  (elderly + diabetic)
# Subgroup B: HR=2.2, Pcons=0.85, n=45  (smokers)
# With sg_focus="hr", selects Subgroup A (better consistency)
```

## sg_focus = "maxSG" {.tabset}

### Statistical Goal
Identify the **largest subgroup** with any consistent harmful effect

### Selection Priority
1. Largest sample size (N)
2. Highest consistency rate (Pcons)
3. Smallest number of factors (K)

### When to Use
- You want to **protect the most patients** from harm
- Population health perspective
- Implementing broad safety restrictions

### Example Code
```{r maxsg-example, eval=FALSE}
# Goal: Treatment guidelines for health system
# Need: Protect maximum patients from harm
result <- forestsearch(
  df.analysis = population_data,
  sg_focus = "maxSG",           # Largest affected group
  hr.threshold = 1.2,           # Lower threshold acceptable
  pconsistency.threshold = 0.85 # Moderate confidence OK
)

# Example results:
# Subgroup A: HR=1.3, n=200, Pcons=0.91 (age > 65)
# Subgroup B: HR=1.8, n=80,  Pcons=0.93 (age > 65 + diabetic)
# Subgroup C: HR=2.5, n=30,  Pcons=0.95 (age > 65 + diabetic + CKD)
# With sg_focus="maxSG", selects Subgroup A (affects 200 patients)
```

## sg_focus = "minSG" {.tabset}

### Statistical Goal
Identify the **smallest, most specific subgroup** with consistent harm

### Selection Priority
1. Smallest sample size (N)
2. Highest consistency rate (Pcons)
3. Smallest number of factors (K)

### When to Use
- You want the most **targeted/specific** risk group
- Minimizing treatment restrictions
- Precision medicine applications

### Example Code
```{r minsg-example, eval=FALSE}
# Goal: Precision medicine approach
# Need: Most specific high-risk profile
result <- forestsearch(
  df.analysis = clinical_trial,
  sg_focus = "minSG",           # Most specific group
  hr.threshold = 1.5,           # High threshold for specificity
  pconsistency.threshold = 0.85 # Moderate confidence acceptable
)

# Using same example subgroups:
# With sg_focus="minSG", selects Subgroup C
# (Most specific: only 30 patients with all 3 risk factors)
```

## sg_focus = "hrMaxSG" {.tabset}

### Statistical Goal
Among subgroups with **meaningful harm** (HR > threshold), find the **largest**
  
  ### Two-Stage Selection
  1. First filter: Only subgroups with clinically important harm
2. Then select: The largest subgroup from filtered set

### When to Use
- Balance between **effect size and impact**
  - Want to protect many patients BUT only if harm is substantial
- Regulatory decisions with effect size thresholds

### Example Code
```{r hrmaxsg-example, eval=FALSE}
# Goal: Balance clinical significance with population impact
result <- forestsearch(
  df.analysis = trial_data,
  sg_focus = "hrMaxSG",         # Large group with meaningful harm
  hr.threshold = 1.5,           # Meaningful harm threshold
  pconsistency.threshold = 0.90 # High confidence
)

# Example with HR threshold = 1.5:
# Subgroup A: HR=1.3, n=200 (excluded: HR < 1.5)
# Subgroup B: HR=1.8, n=80  (included)
# Subgroup C: HR=2.5, n=30  (included)
# Selects Subgroup B (largest among those with HR > 1.5)
```

## sg_focus = "hrMinSG" {.tabset}

### Statistical Goal
Among subgroups with **meaningful harm**, find the **most specific**
  
  ### Two-Stage Selection
  1. First filter: Only subgroups with clinically important harm
2. Then select: The smallest/most specific from filtered set

### When to Use
- Identify **highest-risk patients** for special monitoring
- Design targeted safety protocols
- Companion diagnostic development

### Example Code
```{r hrminsg-example, eval=FALSE}
# Goal: Identify specific biomarker profile for treatment exclusion
result <- forestsearch(
  df.analysis = cancer_trial,
  sg_focus = "hrMinSG",         # Specific + harmful
  hr.threshold = 1.5,           # High harm threshold
  pconsistency.threshold = 0.90 # High confidence
)

# With HR threshold = 1.5:
# Selects Subgroup C (smallest among those with HR > 1.5)
# Most specific profile of patients with substantial harm
```

# Statistical Decision Framework

## Decision Tree Visualization
```{r decision-tree, echo=TRUE}
# Create decision tree for sg_focus selection
grViz("
digraph sg_focus_decision {
  graph [layout = dot, rankdir = TB, fontsize = 14,
         label = 'Choosing sg_focus Based on Study Goals', 
         labelloc = t]
  
  node [shape = box, style = 'filled,rounded', fillcolor = lightblue,
        fontname = Arial, fontsize = 11]
  
  # Start node
  start [label = 'Study Goal', shape = ellipse, fillcolor = lightgreen]
  
  # Goal nodes
  goal1 [label = 'Regulatory\\nSafety', fillcolor = '#FFE6E6']
  goal2 [label = 'Population\\nHealth', fillcolor = '#E6F3FF']
  goal3 [label = 'Precision\\nMedicine', fillcolor = '#E6FFE6']
  goal4 [label = 'Benefit-Risk\\nBalance', fillcolor = '#FFFFE6']
  goal5 [label = 'Biomarker\\nDevelopment', fillcolor = '#F3E6FF']
  
  # sg_focus nodes
  hr [label = 'sg_focus = \"hr\"\\nMost reliable evidence', 
      shape = ellipse, fillcolor = '#FFB6C1']
  maxSG [label = 'sg_focus = \"maxSG\"\\nProtect most patients', 
         shape = ellipse, fillcolor = '#87CEEB']
  minSG [label = 'sg_focus = \"minSG\"\\nMost targeted restriction', 
         shape = ellipse, fillcolor = '#98FB98']
  hrMaxSG [label = 'sg_focus = \"hrMaxSG\"\\nLarge group + meaningful harm', 
           shape = ellipse, fillcolor = '#FAFAD2']
  hrMinSG [label = 'sg_focus = \"hrMinSG\"\\nSpecific high-risk signature', 
           shape = ellipse, fillcolor = '#DDA0DD']
  
  # Edges
  start -> goal1
  start -> goal2
  start -> goal3
  start -> goal4
  start -> goal5
  
  goal1 -> hr
  goal2 -> maxSG
  goal3 -> minSG
  goal4 -> hrMaxSG
  goal5 -> hrMinSG
}
")
```

## Decision Function
```{r decision-function}
#' Decide sg_focus Based on Study Goal
#'
#' @param study_goal Character string indicating the primary study goal
#' @return Recommended sg_focus setting
#' @examples
#' decide_sg_focus("regulatory_safety")
#' decide_sg_focus("population_health")

decide_sg_focus <- function(study_goal) {
  
  decision_map <- list(
    "regulatory_safety" = "hr",        # Most reliable evidence
    "population_health" = "maxSG",     # Protect most patients
    "precision_medicine" = "minSG",    # Most targeted restriction
    "benefit_risk_balance" = "hrMaxSG", # Large group with meaningful harm
    "biomarker_development" = "hrMinSG" # Specific high-risk signature
  )
  
  if (!study_goal %in% names(decision_map)) {
    stop("Unknown study goal. Choose from: ", 
         paste(names(decision_map), collapse = ", "))
  }
  
  sg_focus <- decision_map[[study_goal]]
  
  cat("Study Goal:", study_goal, "\n")
  cat("Recommended sg_focus:", sg_focus, "\n")
  
  return(sg_focus)
}

# Example usage
decide_sg_focus("regulatory_safety")
```

# Impact on Algorithm Behavior

## Internal Sorting Logic
```{r sorting-logic, eval=FALSE}
# From subgroup_consistency.R
sort_subgroups <- function(result_new, sg_focus) {
  if (sg_focus == "hr") 
    data.table::setorder(result_new, -Pcons, -hr, K)  # Reliability first
  
  if (sg_focus %in% c("hrMaxSG", "maxSG")) 
    data.table::setorder(result_new, -N, -Pcons, K)   # Size first
  
  if (sg_focus %in% c("hrMinSG", "minSG")) 
    data.table::setorder(result_new, N, -Pcons, K)    # Specificity first
  
  result_new
}
```

## Parameter Interactions
```{r parameter-interactions, echo=FALSE}
param_interact <- data.frame(
  sg_focus = c("hr", "maxSG", "minSG", "hrMaxSG", "hrMinSG"),
  Typical_hr_threshold = c("1.25 (moderate)", "1.10 (low)", "1.50 (high)", 
                           "1.30 (moderate)", "1.50 (high)"),
  Typical_pconsistency = c("0.90 (high)", "0.85 (moderate)", "0.85 (moderate)",
                           "0.90 (high)", "0.90 (high)"),
  stop_threshold = c("0.90", "Variable*", "Variable*", "1.00", "1.00"),
  stringsAsFactors = FALSE
)

kable(param_interact,
      caption = "Typical Parameter Settings by sg_focus",
      col.names = c("sg_focus", "Typical hr.threshold", 
                    "Typical pconsistency.threshold", "stop.threshold"))
```

*Variable stop.threshold for size-based focus requires special handling based on the specific analysis goals.

# Practical Examples by Study Type

## Phase II Safety Study
```{r phase2-example, eval=FALSE}
# Option 1: Find most reliable signal
result_reliable <- forestsearch(
  df.analysis = phase2_data,
  sg_focus = "hr",              # Most reliable signal
  hr.threshold = 1.25,
  pconsistency.threshold = 0.85,
  n.min = 30,                   # Smaller sample OK for phase II
  d0.min = 5,
  d1.min = 5
)

# Option 2: Find highest-risk profile
result_highrisk <- forestsearch(
  df.analysis = phase2_data,
  sg_focus = "minSG",           # Most specific risk
  hr.threshold = 1.5,           # Higher threshold
  pconsistency.threshold = 0.80,
  n.min = 20,                   # Very specific groups OK
  d0.min = 5,
  d1.min = 5
)
```

## Phase III Confirmatory Trial
```{r phase3-example, eval=FALSE}
# Option 1: Regulatory standard
result_regulatory <- forestsearch(
  df.analysis = phase3_data,
  sg_focus = "hr",              # Regulatory standard
  hr.threshold = 1.3,
  pconsistency.threshold = 0.95, # Very high confidence
  n.min = 100,                  # Large samples required
  d0.min = 20,
  d1.min = 20
)

# Option 2: If population impact matters
result_population <- forestsearch(
  df.analysis = phase3_data,
  sg_focus = "hrMaxSG",         # Balance effect and size
  hr.threshold = 1.3,
  hr.consistency = 1.15,        # Must maintain effect
  pconsistency.threshold = 0.90,
  n.min = 80
)
```

## Post-Market Surveillance
```{r postmarket-example, eval=FALSE}
# Population protection priority
result_surveillance <- forestsearch(
  df.analysis = realworld_data,
  sg_focus = "maxSG",           # Protect most patients
  hr.threshold = 1.15,          # Lower threshold for safety
  pconsistency.threshold = 0.85,
  n.min = 100,
  d0.min = 15,
  d1.min = 15
)
```

## Biomarker Development
```{r biomarker-example, eval=FALSE}
# Specific signature with large effect
result_biomarker <- forestsearch(
  df.analysis = biomarker_trial,
  sg_focus = "hrMinSG",         # Specific + harmful
  hr.threshold = 2.0,           # Large effect required
  hr.consistency = 1.5,         # Must maintain large effect
  pconsistency.threshold = 0.90,
  n.min = 30,                   # Small specific groups OK
  d0.min = 10,
  d1.min = 10
)
```

# Accessing Results

## Understanding Output Structure
```{r output-structure, eval=FALSE}
# The grp.consistency object contains results for all approaches
fs_result <- forestsearch(df.analysis = trial_data, sg_focus = "hr")

# Access different sorting results
hr_results <- fs_result$grp.consistency$out_hr      # Sorted by HR priority
maxSG_results <- fs_result$grp.consistency$out_maxSG # Sorted by size (large)
minSG_results <- fs_result$grp.consistency$out_minSG # Sorted by size (small)

# The final selection depends on sg_focus
final_subgroup <- fs_result$sg.harm  # This is determined by sg_focus

# View top 10 candidates by different criteria
if (!is.null(hr_results)) {
  print(hr_results$result[1:min(10, nrow(hr_results$result)), ])
}
```

## Comparing Different sg_focus Results
```{r compare-results, eval=FALSE}
# Run same analysis with different sg_focus settings
compare_sg_focus <- function(df, ...) {
  
  focus_options <- c("hr", "maxSG", "minSG", "hrMaxSG", "hrMinSG")
  results <- list()
  
  for (focus in focus_options) {
    cat("\nRunning with sg_focus =", focus, "\n")
    
    res <- forestsearch(
      df.analysis = df,
      sg_focus = focus,
      details = FALSE,
      ...
    )
    
    if (!is.null(res$sg.harm)) {
      results[[focus]] <- list(
        subgroup = res$sg.harm,
        size = sum(res$df.est$treat.recommend == 0),
        consistency = res$grp.consistency$out_hr$result$Pcons[1]
      )
    } else {
      results[[focus]] <- "No subgroup found"
    }
  }
  
  return(results)
}

# Example usage
comparison <- compare_sg_focus(
  df = trial_data,
  hr.threshold = 1.25,
  pconsistency.threshold = 0.85,
  n.min = 50
)
```

# Statistical Considerations

## Power Trade-offs
```{r power-tradeoffs, echo=FALSE}
power_comparison <- data.frame(
  sg_focus = c("maxSG", "minSG", "hr"),
  Statistical_Power = c("Higher (more patients)", 
                        "Lower (fewer patients)", 
                        "Balanced"),
  Effect_Size = c("Potentially diluted", 
                  "Potentially stronger", 
                  "Based on consistency"),
  Clinical_Impact = c("Broad restrictions", 
                      "Targeted restrictions", 
                      "Evidence-based restrictions"),
  stringsAsFactors = FALSE
)

kable(power_comparison,
      caption = "Power and Impact Trade-offs by sg_focus")
```

## Implicit Utility Functions
```{r utility-functions}
# Utility function implicit in each focus

utility_hr <- function(subgroup) {
  # Maximize: consistency * effect_size
  subgroup$Pcons * subgroup$hr
}

utility_maxSG <- function(subgroup) {
  # Maximize: affected_population * (effect > threshold)
  subgroup$N * (subgroup$hr > hr.threshold)
}

utility_minSG <- function(subgroup) {
  # Maximize: specificity * effect_size
  (1/subgroup$N) * subgroup$hr
}

utility_hrMaxSG <- function(subgroup, hr.threshold) {
  # Maximize: size | hr > threshold
  ifelse(subgroup$hr > hr.threshold, subgroup$N, 0)
}

utility_hrMinSG <- function(subgroup, hr.threshold) {
  # Maximize: specificity | hr > threshold  
  ifelse(subgroup$hr > hr.threshold, 1/subgroup$N * subgroup$hr, 0)
}
```

# Sensitivity Analysis

## Testing Multiple sg_focus Settings
```{r sensitivity-analysis, eval=FALSE}
# Sensitivity analysis across sg_focus options
run_sg_sensitivity <- function(df, base_params) {
  
  focus_grid <- c("hr", "maxSG", "minSG", "hrMaxSG", "hrMinSG")
  
  results <- data.frame(
    sg_focus = character(),
    subgroup_found = logical(),
    subgroup_size = integer(),
    subgroup_hr = numeric(),
    consistency = numeric(),
    n_factors = integer(),
    stringsAsFactors = FALSE
  )
  
  for (focus in focus_grid) {
    res <- do.call(forestsearch, c(
      list(df.analysis = df, sg_focus = focus),
      base_params
    ))
    
    if (!is.null(res$sg.harm)) {
      results <- rbind(results, data.frame(
        sg_focus = focus,
        subgroup_found = TRUE,
        subgroup_size = sum(res$df.est$treat.recommend == 0),
        subgroup_hr = res$grp.consistency$out_hr$result$hr[1],
        consistency = res$grp.consistency$out_hr$result$Pcons[1],
        n_factors = length(res$sg.harm),
        stringsAsFactors = FALSE
      ))
    } else {
      results <- rbind(results, data.frame(
        sg_focus = focus,
        subgroup_found = FALSE,
        subgroup_size = NA,
        subgroup_hr = NA,
        consistency = NA,
        n_factors = NA,
        stringsAsFactors = FALSE
      ))
    }
  }
  
  return(results)
}

# Example usage
base_params <- list(
  hr.threshold = 1.25,
  pconsistency.threshold = 0.85,
  n.min = 50,
  d0.min = 10,
  d1.min = 10
)

sensitivity_results <- run_sg_sensitivity(trial_data, base_params)
print(sensitivity_results)
```

# Key Insights and Recommendations

## Philosophy of Each Approach
```{r philosophy-table, echo=FALSE}
philosophy <- data.frame(
  sg_focus = c("hr", "maxSG", "minSG", "hrMaxSG", "hrMinSG"),
  Core_Question = c(
    "What harm are we most sure about?",
    "How many patients could we protect?",
    "Who is at highest risk?",
    "What's the biggest problem we're confident about?",
    "What's the most specific serious risk?"
  ),
  Statistical_Philosophy = c(
    "Maximize reliability",
    "Maximize coverage",
    "Maximize specificity",
    "Balance impact and confidence",
    "Precision with significance"
  ),
  Clinical_Philosophy = c(
    "Evidence-based medicine",
    "Population health",
    "Precision medicine",
    "Risk-benefit optimization",
    "Targeted intervention"
  ),
  stringsAsFactors = FALSE
)

DT::datatable(philosophy,
              caption = "Philosophy Behind Each sg_focus Option",
              options = list(pageLength = 5, dom = 't'))
```

## Summary Recommendations

1. **Start with `sg_focus = "hr"`** for initial exploration - most balanced approach
2. **Consider your stakeholders**: 
  - Regulators → "hr"
- Health systems → "maxSG"
- Precision medicine → "minSG" or "hrMinSG"
3. **Run sensitivity analyses** with multiple sg_focus settings
4. **Document your choice** and rationale in study protocols
5. **Report results from multiple perspectives** even if one is primary

## Final Notes

- All sg_focus options evaluate the **same candidate subgroups**
  - The parameter only affects **which one is selected as primary**
  - No additional multiple testing burden between options
- Consider pre-specifying sg_focus in your statistical analysis plan

---
  
  *This document provides comprehensive guidance on the sg_focus parameter in ForestSearch. Each option represents a valid statistical and clinical perspective on subgroup identification for treatment harm.*